$(function(){if($(".flashsale").length){var t=$("body").data("pis"),a=$("body").data("now");$(".flashsale").each(function(e,i){var r=$(i),n=r.find(".leftTr"),s=r.find(".rightTr"),d=r.find(".swiper-wrapper").width(),l=0;if(n.on("touchstart",function(){var t=r.find(".swiper-active .timeli.active").data("scrollEle");t&&t.x<0&&t.scrollBy(250,0,1e3,IScroll.utils.ease.quadratic)}),s.on("touchstart",function(){var t=r.find(".swiper-active .timeli.active").data("scrollEle");t&&t.x>t.maxScrollX&&t.scrollBy(-250,0,1e3,IScroll.utils.ease.quadratic)}),r.find(".flash-button-next").on("touchstart",function(){var t=r.find(".swiper-active");return l=-t.index()*d,r.find(".flash-button-prev").show(),t.next().next().length?$(this).show():$(this).hide(),t.next().length?(t.removeClass("swiper-active"),t.next().addClass("swiper-active"),l-=d,r.find(".swiper-wrapper").css("transform","translate3d("+l+"px, 0px, 0px)"),r.find(".swiper-wrapper").css("transition-duration","300ms"),void(r.find(".swiper-active .timeli[data-label='1']").length?r.find(".swiper-active .timeli[data-label='1']").find(".day").trigger("touchstart"):r.find(".swiper-active .timeli").first().find(".day").trigger("touchstart"))):!1}),r.find(".flash-button-prev").on("touchstart",function(){var t=r.find(".swiper-active");return l=-t.index()*d,r.find(".flash-button-next").show(),t.prev().prev().length?$(this).show():$(this).hide(),t.prev().length?(t.removeClass("swiper-active"),t.prev().addClass("swiper-active"),l+=d,r.find(".swiper-wrapper").css("transform","translate3d("+l+"px, 0px, 0px)"),r.find(".swiper-wrapper").css("transition-duration","300ms"),void(r.find(".swiper-active .timeli[data-label='1']").length?r.find(".swiper-active .timeli[data-label='1']").find(".day").trigger("touchstart"):r.find(".swiper-active .timeli").first().find(".day").trigger("touchstart"))):!1}),r.find(".swiper-wrapper").on("webkitTransitionEnd",function(){echo.render()}),r.find(".day").on("touchstart",function(){var e=$(this).parent();if(e.addClass("active"),e.data("active")&&(e.css("background",e.data("active")),e.siblings().each(function(t,a){$(a).data("tab")?$(a).css("background",$(a).data("tab")):$(a).removeAttr("style")})),e.siblings().removeClass("active"),e.hasClass("clicked"))return!1;var i=e.data("category"),r=e.data("from"),n=(e.data("time"),e.data("to")),s=e.data("date"),d=moment(s+" "+r),l=moment(a),o="";return o=n?moment(s+" "+n):moment(s).add(1,"d"),e.addClass("clicked"),$.ajax({type:"get",url:t+"/global/search?pageSize=10000&categoryId="+i,dataType:"json",beforeSend:function(){e.parent().append("<div class='flash-mask'></div>")},success:function(t){d.diff(l)>0&&(t.label=0),l.diff(d)>0&&o.diff(l)>0&&(t.label=1),l.diff(d.add(30,"m"))>0&&(t.label=2);var a=template("flashTpl",t),i=$(a);t.data&&i.width(6.875*t.data.length+.625+"rem");var r=e.find(".time-content");r.html(i);var n=new IScroll(r[0],{scrollX:!0,scrollY:!1,bounce:!1,preventDefault:!1,eventPassthrough:!0}),s=$(".swiper-active .timeli.active");n.on("scrollStart",function(){echo.render()}),n.on("scrollEnd",function(){echo.render()}),s.data("scrollEle",n),echo.render();var f="";e.find(".time-content .flash-product").each(function(t,a){f+=f?","+$(a).data("id"):$(a).data("id")}),e.parent().find(".flash-mask").remove(),f&&$.ajax({url:$("body").data("pis")+"/global/price",type:"get",dataType:"json",traditional:!0,data:{productIds:f},success:function(a){for(var e=a.data,i=0;i<e.length;i++){var r=$(".flash-product[data-id="+e[i].productId+"]");parseInt(e[i].stockStatus)||0==t.label||2==t.label||r.append("<div class='stack-over'>抢光了</div>"),r.find(".price em").html("￥"+e[i].specialPrice),r.find(".price del").html(e[i].originPrice)}}})},error:function(){e.parent().find(".flash-mask").remove(),console.log("flash sale data error")}}),!1}),r.find(".timeli").each(function(t,e){var i=$(e),r=($(this).data("category"),$(this).data("from")),n=$(this).data("to"),s=$(this).data("date"),d=moment(s+" "+r),l=moment(a),o="";o=n?moment(s+" "+n):moment(s).add(1,"d"),d.diff(l)>0&&(i.attr("data-label",0),i.find(".flash-label").html("未开始")),l.diff(d)>0&&o.diff(l)>0&&(i.attr("data-label",1),i.find(".flash-label").html("疯抢中")),l.diff(d.add(30,"m"))>0&&(i.attr("data-label",2),i.find(".flash-label").html("已结束"))}),r.find(".timeli[data-label='1']").length){var o=r.find(".timeli[data-label=1]"),f=o.closest(".swiper-wrapper"),l=0,d=r.find(".swiper-wrapper").width(),c=o.closest(".swiper-slide"),e=c.index();f.css("transform","translate3d("+(l-e*d)+"px, 0px, 0px)"),c.next().length?c.prev().length?(r.find(".flash-button-prev").show(),r.find(".flash-button-next").show()):(r.find(".flash-button-prev").hide(),r.find(".flash-button-next").show()):(r.find(".flash-button-next").hide(),r.find(".flash-button-prev").show()),f.find(".swiper-slide").removeClass("swiper-active"),c.addClass("swiper-active"),o.find(".day").trigger("touchstart")}else r.find(".swiper-active .timeli").first().find(".day").trigger("touchstart")})}});